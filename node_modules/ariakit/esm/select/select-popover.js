import { useState, useEffect } from 'react';
import { toArray } from 'ariakit-utils/array';
import { createHook, createComponent, createElement } from 'ariakit-utils/system';
import { usePopover } from '../popover/popover.js';
import { a as findEnabledItemByValue } from '../__utils-ce9ba82e.js';
import { useSelectList } from './select-list.js';

/**
 * A component hook that returns props that can be passed to `Role` or any other
 * Ariakit component to render a select popover.
 * @see https://ariakit.org/components/select
 * @example
 * ```jsx
 * const state = useSelectState();
 * const props = useSelectPopover({ state });
 * <Role {...props}>
 *   <SelectItem value="Apple" />
 *   <SelectItem value="Orange" />
 * </Role>
 * ```
 */

const useSelectPopover = createHook(_ref => {
  var _values;

  let {
    state,
    ...props
  } = _ref;
  const values = toArray(state.value);
  const value = (_values = values[values.length - 1]) != null ? _values : "";
  const [item, setItem] = useState(null); // Sets the initial focus ref.

  useEffect(() => {
    let cleaning = false;
    setItem(prevItem => {
      if (cleaning) return null; // This must be state.open instead of state.mounted, otherwise
      // re-opening an animated popover before the leave animation is done
      // will not restore focus to the correct item.

      if (state.open && prevItem) return prevItem;
      const item = findEnabledItemByValue(state.items, value);
      return item || null;
    });
    return () => {
      cleaning = true;
    };
  }, [state.open, state.items, value]);
  props = useSelectList({
    state,
    ...props
  });
  props = usePopover({
    state,
    initialFocusRef: (item == null ? void 0 : item.ref) || state.baseRef,
    ...props
  });
  return props;
});
/**
 * A component that renders a select popover. The `role` prop is set to
 * `listbox` by default, but can be overriden by any other valid select popup
 * role (`listbox`, `menu`, `tree`, `grid` or `dialog`).
 * @see https://ariakit.org/components/select
 * @example
 * ```jsx
 * const select = useSelectState();
 * <Select state={select} />
 * <SelectPopover state={select}>
 *   <SelectItem value="Apple" />
 *   <SelectItem value="Orange" />
 * </SelectPopover>
 * ```
 */

const SelectPopover = createComponent(props => {
  const htmlProps = useSelectPopover(props);
  return createElement("div", htmlProps);
});

if (process.env.NODE_ENV !== "production") {
  SelectPopover.displayName = "SelectPopover";
}

export { SelectPopover, useSelectPopover };
